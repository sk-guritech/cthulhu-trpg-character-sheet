
<!DOCTYPE html>
<html lang="ja">
	<head>
		<script src="https://unpkg.com/vue@next"></script>
		<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/src/FileSaver.js"></script>
		<script src="https://unpkg.com/jszip@3.7.1/lib/index.js"></script>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
		<meta charset="utf-8"/>

		<title></title>

	</head>
	<body>
		<div id="app" style="">
			<div class="abilities">

			</div>
			<div class="skills">
				<div style="font-size: larger; border-bottom: 1px black solid; width:33.5em; margin: 2em; margin-bottom: -1em">Skills</div>
				<div style="display: grid; grid-template-columns: 13.5em 13.5em 13.5em; margin:2em; margin-left: 3em;">
					<skill_card v-for="item in skills" :skill_name="item.skill_name" :skill_value="item.value" :is_checked="item.is_checked" @change-skill-status="change_skill_status" @delete-skill="delete_skill"/></skill_card>

					<div style="display: flex;align-items: center; padding: 0.5em; padding-top:0.1em; padding-bottom: 0.1em; border-bottom: 1px black solid ; width: 12em;">
						<button v-on:click="add_new_skill" class="btn btn-secondary" style="padding: 0.1em; margin-left: -0.05em">+</button>
						<input class="new-skill-name" type="text" name="" style="width:6.1em;font-size: small;margin-left:0.4em;">
						<input class="new-skill-value" type="number" value=0 style="margin-left: 0.2em;width: 3em" min="0" max="99" onkeypress="return (event.charCode == 8 || event.charCode == 0) ? null : event.charCode >= 48 && event.charCode <= 57">
					</div>
				</div>
			</div>

			<div style="margin: 2em">
				<a v-on:click="save_sheet" style="margin: 0.5em" class="btn btn-success">save</a>
				<label>
					<span  class="btn btn-primary">
						Choose File
						<input type="file" @change="load_sheet" style="display: none">
					</span>
				</label>
			</div>
		</div>

	</body>
</html>


<script type="text/javascript">
	document.oncontextmenu = function () {return false;}
	const app = Vue.createApp({
		data() {
			return {
				skills:[
				]
			}
		},
		methods:{
			save_sheet(){
				var blob = new Blob([JSON.stringify(this.skills)], {type: "text/plain;charset=utf-8"});
				saveAs(blob, "sheet.json");
			},
			load_sheet(event){
				var _this = this;
				var file = event.target.files[0];
				var reader = new FileReader();
				reader.readAsText(file);

				reader.onload = () => {
					var json = JSON.parse(reader.result);
					this.skills = json;
				};
			},
			change_skill_status(event_value){
				console.log(event_value);
				var skill_index = 0;
				this.skills.forEach((elem, index) => {
					if(elem.skill_name == event_value[1]){
						skill_index = index;
					}
				});		

				if(event_value[0][0] == 'f' || event_value[0][0] == 't'){
					this.skills[skill_index]["is_checked"] = event_value[0] == "true" ? true : false;
				}else{
					if(parseInt(event_value[0]) > 99){
						event_value[0] = 99;
					}else if(parseInt(event_value[0] < 0)){
						event_value[0] = 0;
					}

					//実パラメーター配列の更新
					this.skills[skill_index]["value"] = parseInt(event_value[0]);			
				}
			},
			delete_skill(event_value){
				this.skills.forEach((elem, index) => {
					if(elem.skill_name == event_value[1])this.skills.splice(index,1);
				});
			},
			add_new_skill(event){
				var new_skill_value = parseInt(document.getElementsByClassName("new-skill-value")[0].value);
				var new_skill_name = document.getElementsByClassName("new-skill-name")[0].value;
				document.getElementsByClassName("new-skill-name")[0].value = "";
				if(!new_skill_value && new_skill_value != 0)return;
				if(!new_skill_name)return;

				this.skills.forEach((elem, index) => {
					if(elem.skill_name == new_skill_name)this.skills.splice(index,1);
				});				
				this.skills.push({skill_name:new_skill_name, value:new_skill_value, is_checked:false});
			}
		}
	});

	app.component("skill_card",{
		props: ['skill_name','skill_value'],
		props: {
			skill_name: {
				type: String,
				required: true
			},
			skill_value: {
				type: Number,
				required: true
			},
			is_checked: {
				type: Boolean,
				required: true
			}
		},
		template: `
			<div style="display: flex;align-items: center; padding: 0.5em; padding-top:0.1em; padding-bottom: 0.1em; border-bottom: 1px black solid ; width: 12em;">
				<input v-if="is_checked==true" type="checkbox" checked value=false @change="onChangeInput">
				<input v-else type="checkbox" value=true @change="onChangeInput">

				<div style="margin-left: 0.4em; width: 8em; font-size:small" @click.right.ctrl="deleteAbility">
					{{skill_name}}:
				</div>
				<div style="margin-left: 0.4em">
					<input :value="skill_value" type="number" @change="onChangeInput" style="width: 3em" min="0" max="99" onkeypress="return (event.charCode == 8 || event.charCode == 0) ? null : event.charCode >= 48 && event.charCode <= 57">
				</div>
				<div style="font-size: x-small; margin-left: 0.6em; margin-top: 0.2em; width:2.5em;">
						<div style="text-decoration: underline; text-underline-position: under;">{{Math.floor(skill_value/2)}}%</div>		
						<div>{{Math.floor(skill_value/5)}}%</div>
				</div>
			</div>
		`,

		methods: {
			onChangeInput(event){
				this.$emit('change-skill-status', [event.target.value, this.skill_name]);
			},
			deleteAbility(event){
				this.$emit('delete-skill', [event, this.skill_name]);
			}
		}
	});

	app.mount("#app");

</script>